<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Timer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background: url('/static/background.png') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Georgia', serif;
            color: #8a4a4a;
        }
        .timer-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
        }
        .timer-container h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #8a4a4a;
        }
        .timer-display {
            font-size: 4rem;
            margin: 20px 0;
            font-family: 'Montserrat', serif;
        }
        .timer-controls button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 1.2rem;
            background-color: #d8a7a7;
            border: none;
            color: white;
            transition: background-color 0.3s ease;
        }
        .timer-controls button:hover {
            background-color: #b87c7c;
        }
        /* Cherry blossom animation */
        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }
        .cherry-blossom {
            position: absolute;
            top: -100px;
            animation: fall 10s linear infinite;
            color: #ff9a9a;
        }
    </style>
</head>
<body>
    <!-- Cherry blossom animation -->
    <div class="cherry-blossom" style="left: 10%;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 20%; animation-delay: 2s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 30%; animation-delay: 4s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 40%; animation-delay: 6s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 50%; animation-delay: 8s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 60%; animation-delay: 10s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 70%; animation-delay: 12s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 80%; animation-delay: 14s;">ðŸŒ¸</div>
    <div class="cherry-blossom" style="left: 90%; animation-delay: 16s;">ðŸŒ¸</div>

    <div class="timer-container">
        <h1 id="timer-label">Learning Time</h1>
        <div class="timer-display" id="timer"></div>
        <div class="timer-controls" id="controls" style="display: none;">
            <button onclick="window.location.href='/timer'">Change Timers</button>
            <button onclick="startTimers()">Start Again</button>
        </div>
        <!-- My Rewards Button -->
        <button id="my-rewards-button" style="position: fixed; top: 20px; right: 20px; padding: 10px 20px; background-color: #d8a7a7; border: none; color: white; cursor: pointer;">
            My Rewards
        </button>
        <!-- Home and Statistics Buttons -->
        <div style="position: fixed; top: 20px; left: 20px; display: flex; gap: 10px;">
            <a href="/" style="padding: 10px 20px; background-color: #d8a7a7; border: none; color: white; text-decoration: none; cursor: pointer;">
                Home
            </a>
            <button id="statistics-button" style="padding: 10px 20px; background-color: #d8a7a7; border: none; color: white; cursor: pointer;">
                Statistics
            </button>
        </div>
    </div>

    <!-- Reward Modal -->
    <div class="modal fade" id="rewardModal" tabindex="-1" aria-labelledby="rewardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rewardTitle">Your Reward!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="rewardImage" src="" alt="Reward" style="width: 100%;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- My Rewards Modal -->
    <div class="modal fade" id="myRewardsModal" tabindex="-1" aria-labelledby="myRewardsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myRewardsModalLabel">My Rewards</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="rewards-container">
                        <!-- Rewards will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Statistics Modal -->
    <div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statisticsModalLabel">Session Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="statistics-container">
                        <!-- Statistics will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Active Timer -->
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let learningTime = parseInt(urlParams.get('learning')) || 30;
        let breakTime = parseInt(urlParams.get('break_time')) || 5;
        let rewardType = urlParams.get('reward_type') || 'animals'; // Get reward_type

        let isLearning = true;
        let timeRemaining = learningTime * 60;
        let timerInterval;

        // Initialize the timer display immediately
        function initializeTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        async function showReward() {
            let imageUrl = '';
            let rewardTypeName = rewardType === 'lol_skins' ? 'LOL Skin' : 'Animal';
            let champion = '';
            let skin = '';

            // Get existing rewards from localStorage
            const rewards = JSON.parse(localStorage.getItem('rewards')) || [];

            if (rewardType === 'lol_skins') {
                const champions = ['Ahri', 'Lux', 'Seraphine', 'Lulu', 'Morgana',
                    'Yuumi', 'Sona', 'Janna', 'Zyra', 'Heimerdinger', 'Nami', 'Soraka',
                    'Jinx', 'MissFortune', 'Ashe', 'Caitlyn', 'Vayne', 'Jhin', 'Kaisa',
                    'Katarina', 'Samira', 'Leblanc', 'Senna', 'Smolder', 'Syndra', 'Xayah',
                ];

                let isDuplicate = true;

                while (isDuplicate) {
                    const randomChampion = champions[Math.floor(Math.random() * champions.length)];
                    const response = await fetch(`https://ddragon.leagueoflegends.com/cdn/13.19.1/data/en_US/champion/${randomChampion}.json`);
                    const data = await response.json();
                    const skins = data.data[randomChampion].skins;
                    const randomSkin = skins[Math.floor(Math.random() * (skins.length - 1)) + 1]; // Exclude default skin
                    imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/splash/${randomChampion}_${randomSkin.num}.jpg`;
                    champion = randomChampion;
                    skin = randomSkin.name;

                    // Check if the reward is a duplicate
                    isDuplicate = rewards.some(r => r.champion === champion && r.skin === skin);
                }

            } else {
                let isDuplicate = true;

                while (isDuplicate) {
                    const response = await fetch('https://api.thecatapi.com/v1/images/search');
                    const data = await response.json();
                    imageUrl = data[0].url;

                    // Check if the reward is a duplicate
                    isDuplicate = rewards.some(r => r.url === imageUrl);
                }
            }

            // Save the reward to localStorage
            const reward = {
                type: rewardTypeName,
                url: imageUrl,
                timestamp: new Date().toLocaleString(),
                champion: champion,
                skin: skin
            };
            saveReward(reward);

            // Display the reward in the pop-up
            const rewardImage = document.getElementById('rewardImage');
            const rewardTitle = document.getElementById('rewardTitle');
            rewardImage.src = imageUrl;

            if (rewardType === 'lol_skins') {
                rewardTitle.textContent = `Your Reward: ${champion} - ${skin}`;
            } else {
                rewardTitle.textContent = 'Your Reward: Cute Animal!';
            }

            const rewardModal = new bootstrap.Modal(document.getElementById('rewardModal'));
            rewardModal.show();
        }

        function saveReward(reward) {
            // Get existing rewards from localStorage
            const rewards = JSON.parse(localStorage.getItem('rewards')) || [];
            // Add the new reward
            rewards.push(reward);
            // Save back to localStorage
            localStorage.setItem('rewards', JSON.stringify(rewards));
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                if (timeRemaining < 0) {
                    clearInterval(timerInterval);
                    if (isLearning) {
                        // Update session statistics
                        updateSessionStatistics(learningTime * 60); // Convert minutes to seconds

                        // Show the reward pop-up
                        showReward();

                        // Switch to break timer
                        isLearning = false;
                        timeRemaining = breakTime * 60;
                        document.getElementById('timer-label').textContent = 'Break Time';
                        initializeTimerDisplay();
                        startTimer();
                    } else {
                        // Break is over, show controls
                        document.getElementById('controls').style.display = 'block';
                        document.getElementById('timer-label').textContent = 'Time is up!';
                    }
                    return;
                }
                updateTimerDisplay();
            }, 1000);
        }

        function startTimers() {
            window.location.href = `/active-timer?learning=${learningTime}&break_time=${breakTime}&reward_type=${rewardType}`;
        }

        // Initialize the timer display immediately
        initializeTimerDisplay();

        // Start the timer automatically
        startTimer();
    </script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- Include shared.js -->
    <script src="/static/shared.js"></script>
</body>
</html>